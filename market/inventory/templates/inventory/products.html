{% extends 'base.html' %}

{% block content %}
<form method="get" class="mb-3 d-flex align-items-center gap-2">
  <div style="min-width:220px;">
    {{ filter.form.name }}
  </div>

  <div class="dropdown">
    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filtersDropdown" data-bs-toggle="dropdown" aria-expanded="false">
      Filters
    </button>
    <div class="dropdown-menu p-3" aria-labelledby="filtersDropdown" style="min-width:320px;">
      <div class="mb-2">
        <label class="form-label small mb-1">Unit</label>
        {{ filter.form.unit }}
      </div>

      <div class="mb-2">
        <label class="form-label small mb-1">Price</label>
        <div class="d-flex align-items-center gap-2">
          <div class="d-flex flex-column" style="min-width:90px;">
            <small class="text-muted">Min</small>
            {{ filter.form.min_price }}
          </div>
          <div id="min_price_range_wrap" class="d-flex align-items-center">
            <input id="min_price_range" type="range" min="0" max="10000" step="0.01" class="form-range" style="width:140px;" />
          </div>
          <div class="d-flex flex-column" style="min-width:90px;">
            <small class="text-muted">Max</small>
            {{ filter.form.max_price }}
          </div>
        </div>
      </div>

      <div class="mb-2">
        <label class="form-label small mb-1">Quantity</label>
        <div class="d-flex align-items-center gap-2">
          <div class="d-flex flex-column" style="min-width:90px;">
            <small class="text-muted">Min</small>
            {{ filter.form.min_quantity }}
          </div>
          <div id="min_quantity_range_wrap" class="d-flex align-items-center">
            <input id="min_quantity_range" type="range" min="0" max="10000" step="0.01" class="form-range" style="width:140px;" />
          </div>
          <div class="d-flex flex-column" style="min-width:90px;">
            <small class="text-muted">Max</small>
            {{ filter.form.max_quantity }}
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-end">
        <button class="btn btn-sm btn-outline-success me-2" type="submit">Apply</button>
        <a class="btn btn-sm btn-secondary" href="?">Reset</a>
      </div>
    </div>
  </div>

  <button class="btn btn-outline-success" type="submit">Apply</button>
  <a class="btn btn-secondary" href="?">Reset</a>
</form>

<script>

function syncRange(rangeEl, numberEl) {
  if (!rangeEl || !numberEl) return;

  const n = parseFloat(numberEl.value);
  if (!isNaN(n)) rangeEl.value = n;

  rangeEl.addEventListener('input', function() { numberEl.value = this.value; });

  numberEl.addEventListener('input', function() { rangeEl.value = this.value || rangeEl.min; });
}

document.addEventListener('DOMContentLoaded', function() {
  syncRange(document.getElementById('min_price_range'), document.getElementById('id_min_price'));
  syncRange(document.getElementById('min_quantity_range'), document.getElementById('id_min_quantity'));
  function toggleSliderVisibility(numberEl, sliderWrap) {
    if (!numberEl || !sliderWrap) return;
    const check = () => {
      if (numberEl.value && String(numberEl.value).trim() !== '') {
        sliderWrap.style.display = 'none';
      } else {
        sliderWrap.style.display = '';
      }
    };
    check();
    numberEl.addEventListener('input', check);
  }

  toggleSliderVisibility(document.getElementById('id_min_price'), document.getElementById('min_price_range_wrap'));
  toggleSliderVisibility(document.getElementById('id_max_price'), document.getElementById('min_price_range_wrap'));
  toggleSliderVisibility(document.getElementById('id_min_quantity'), document.getElementById('min_quantity_range_wrap'));
  toggleSliderVisibility(document.getElementById('id_max_quantity'), document.getElementById('min_quantity_range_wrap'));
});
</script>
<table class="table table-striped">
  <thead>
    <tr>
      <th scope="col" class="text-start">#</th>
      <th scope="col" class="text-start">Name</th>
      <th scope="col" class="text-start">Price per unit</th>
      <th scope="col" class="text-start">Quantity</th>
      <th scope="col" class="text-start">Unit of measurement</th>
      <th scope="col" class="text-start">Rating</th>
      <th scope="col" class="text-start">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for product in products %}
    <tr>
      <th scope="row">{{ forloop.counter }}</th>
      <td><a href="{% url 'inventory:product_detail' product.pk %}">{{ product.name }}</a></td>
      <td>{{ product.unit_price }}</td>
      <td>{{ product.quantity }}</td>
      <td>{{ product.unit }}</td>
      <td>
          {% if product.has_rating %}
            {% for i in "x"|rjust:product.rating_count %}⭐️{% endfor %}
            <small>({{ product.avg_rating }}/5)</small>
          {% else %}
            <small>No ratings</small>
          {% endif %}
      </td>
      <td>
        {% if request.user.is_authenticated %}
        <a class="btn btn-sm btn-success" href="{% url 'inventory:add_to_cart' product.pk %}">Add to Cart</a>
        {% endif %}
        <a class="btn btn-sm btn-outline-primary" href="{% url 'inventory:edit_product' product.pk %}">Edit</a>
        <form method="post" action="{% url 'inventory:delete_product' product.pk %}" style="display:inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-danger ms-1" onclick="return confirm('Delete this product?')">Delete</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Pagination -->
{% if products.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
  <ul class="pagination justify-content-center">
    <!-- Previous button -->
    {% if products.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">First</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ products.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo; Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">First</span>
      </li>
      <li class="page-item disabled">
        <span class="page-link">&laquo; Previous</span>
      </li>
    {% endif %}

    <!-- Page numbers -->
    {% for page_num in page_numbers %}
      {% if page_num == "..." %}
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
      {% elif page_num == products.number %}
        <li class="page-item active">
          <span class="page-link">{{ page_num }}</span>
        </li>
      {% else %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ page_num }}</a>
        </li>
      {% endif %}
    {% endfor %}

    <!-- Next button -->
    {% if products.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ products.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next &raquo;</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ products.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Last</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Next &raquo;</span>
      </li>
      <li class="page-item disabled">
        <span class="page-link">Last</span>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock content %}